<!-- last_updated: 2026-02-11 -->

# 22. 서브에이전트와 병렬 처리

> 서브에이전트를 활용한 작업 위임과 병렬 처리를 다룹니다.

---

## 서브에이전트란?

서브에이전트는 **격리된 컨텍스트**에서 전문화된 역할을 수행하는 독립적인 Claude 인스턴스입니다.

```
메인 세션
├── 서브에이전트 A (코드 탐색) — 별도 컨텍스트
├── 서브에이전트 B (보안 리뷰) — 별도 컨텍스트
└── 서브에이전트 C (테스트 분석) — 별도 컨텍스트
```

### 핵심 특성

- **격리된 컨텍스트**: 메인 대화와 별도의 컨텍스트 윈도우
- **전문화된 역할**: 특정 작업에 최적화된 시스템 프롬프트
- **위임 모델**: 부모 에이전트가 작업을 위임하고 결과를 수신
- **결과 요약**: 서브에이전트의 결과가 메인 세션에 요약 반환

### 서브에이전트를 쓰는 이유

| 이점 | 설명 |
|------|------|
| **컨텍스트 보호** | 메인 대화를 대량의 탐색 결과로 오염시키지 않음 |
| **병렬 처리** | 여러 조사를 동시에 진행 |
| **전문화** | 각 에이전트가 특정 도메인에 집중 |
| **비용 효율** | 가벼운 모델(Haiku)을 탐색에 사용 가능 |

---

## 내장 에이전트 타입

| 에이전트 | 역할 | 기본 모델 |
|---------|------|----------|
| **general-purpose** | 범용 작업 | 상속 |
| **Explore** | 코드 탐색과 분석 | 빠른 모델 |
| **Plan** | 계획과 설계 | 상속 |
| **Bash** | 명령어 실행 전문 | 상속 |
| **code-reviewer** | 코드 품질 리뷰 | 상속 |
| **code-explorer** | 코드 심층 분석 | 상속 |
| **code-architect** | 아키텍처 설계 | 상속 |
| **code-simplifier** | 코드 최적화 | 상속 |

---

## 커스텀 에이전트 만들기

### 디렉토리 구조

```
.claude/agents/           # 프로젝트 에이전트
├── security-auditor.md
├── performance-analyzer.md
└── doc-generator.md

~/.claude/agents/         # 사용자 에이전트
└── personal-reviewer.md
```

### 에이전트 파일 구조

```markdown
---
name: security-auditor
description: "보안 취약점을 전문적으로 분석합니다"
model: sonnet
tools: [Read, Glob, Grep]
disallowedTools: [Write, Edit, Bash]
maxTurns: 10
---

# 보안 감사 에이전트

당신은 보안 전문 감사관입니다.

## 분석 항목
- OWASP Top 10 취약점
- 인증/인가 결함
- 입력 검증 누락
- SQL 인젝션, XSS, CSRF
- 하드코딩된 비밀값
- 안전하지 않은 의존성

## 출력 형식
- 심각도 (Critical/High/Medium/Low)
- 파일 경로와 줄 번호
- 구체적인 수정 제안
```

### 설정 필드

| 필드 | 필수 | 설명 |
|------|:----:|------|
| `name` | O | 에이전트 식별자 |
| `description` | O | 에이전트 역할 설명 |
| `model` | | 사용 모델 (sonnet, opus, haiku, inherit) |
| `tools` | | 허용 도구 목록 |
| `disallowedTools` | | 차단 도구 목록 |
| `permissionMode` | | 권한 모드 (ask, allow, deny) |
| `maxTurns` | | 최대 대화 턴 수 |

---

## `/agents` 명령어

```
> /agents
```

- 사용 가능한 모든 에이전트 (내장 + 커스텀) 표시
- 새 에이전트 생성 가이드
- 에이전트 설정 편집
- 에이전트 활성화/비활성화

---

## 에이전트 호출

### 자동 위임

Claude는 작업 성격에 따라 적절한 서브에이전트를 자동으로 선택합니다:

```
> 이 프로젝트의 인증 시스템을 분석해줘
# Claude가 자동으로 Explore 에이전트에 위임
```

### 명시적 위임

```
> 서브에이전트를 사용해서 보안 감사를 해줘
> Explore 에이전트로 API 엔드포인트를 조사해줘
```

### 스킬에서 에이전트 지정

```markdown
---
name: security-scan
description: "보안 스캔을 실행합니다"
context: fork
agent: security-auditor
---

$ARGUMENTS에 대한 보안 스캔을 수행해주세요.
```

---

## 포그라운드 vs 백그라운드 실행

### 포그라운드 (기본)

서브에이전트가 완료될 때까지 메인 세션이 대기합니다:

```
> 인증 모듈을 분석해줘
[서브에이전트 실행 중...]
[결과 반환]
```

### 백그라운드

`Ctrl+B`로 서브에이전트를 백그라운드로 보내고 다른 작업을 계속합니다:

```
> 인증 모듈을 분석해줘
(Ctrl+B)
> 다른 작업을 진행합니다...
```

`/tasks`로 백그라운드 서브에이전트의 상태를 확인할 수 있습니다.

---

## 서브에이전트 재개

서브에이전트는 고유 ID를 가지며, 나중에 재개할 수 있습니다:

```
# 서브에이전트 결과를 받은 후
> 이전 보안 분석 에이전트에게 추가 질문이 있어
# Claude가 해당 서브에이전트의 컨텍스트를 재개
```

---

## 실전 패턴

### 병렬 코드베이스 분석

```
> 서브에이전트를 사용해서 조사해줘:
> 1. 인증 시스템이 어떻게 작동하는지
> 2. 재사용할 수 있는 OAuth 유틸리티가 있는지
> 3. 테스트 커버리지 현황
```

Claude가 독립적인 서브에이전트들을 병렬로 실행합니다.

### 작성자/리뷰어 패턴

```
# 메인 세션: 코드 작성
> rate limiter를 구현해줘

# 서브에이전트: 리뷰
> 구현한 코드를 리뷰 에이전트로 검토해줘
```

### 테스트 우선 개발

```
# 서브에이전트 1: 테스트 작성
> 테스트 에이전트로 결제 모듈의 테스트를 먼저 작성해줘

# 메인 세션: 구현
> 이 테스트를 통과하는 구현을 작성해줘
```

---

## 요약

| 주제 | 핵심 포인트 |
|------|------------|
| **서브에이전트** | 격리된 컨텍스트, 전문화된 역할, 결과 요약 반환 |
| **내장 타입** | Explore, Plan, code-reviewer 등 7가지 |
| **커스텀** | `.claude/agents/`에 마크다운으로 정의 |
| **설정** | name, model, tools, maxTurns 등 |
| **호출** | 자동 위임, 명시적 요청, 스킬에서 지정 |
| **실행** | 포그라운드 (대기) 또는 백그라운드 (Ctrl+B) |
| **재개** | 서브에이전트 컨텍스트를 나중에 재개 가능 |

---

## 다음 챕터

[23장: 에이전트 팀](05-agent-teams.md)에서 여러 에이전트가 협력하는 실험적 기능을 배웁니다.
